(function(){var a=Object.prototype.hasOwnProperty,b=function(f,d){for(var c in d){if(a.call(d,c)){f[c]=d[c]}}function e(){this.constructor=f}e.prototype=d.prototype;f.prototype=new e;f.__super__=d.prototype;return f};window.CentralAZ=window.CentralAZ||{};CentralAZ.Facebook=CentralAZ.Facebook||{};CentralAZ.Facebook.Models=CentralAZ.Facebook.Models||{};CentralAZ.Facebook.Views=CentralAZ.Facebook.Views||{};CentralAZ.Facebook.Controllers=CentralAZ.Facebook.Controllers||{};CentralAZ.Facebook.Helpers=CentralAZ.Facebook.Helpers||{};CentralAZ.Facebook.Events=CentralAZ.Facebook.Events||{};CentralAZ.Facebook.Controllers.FacebookConnectRouter=(function(c){b(d,c);function d(){d.__super__.constructor.apply(this,arguments)}d.prototype.routes={"":"index","*options":"index"};d.prototype.initialize=function(e){if(e.model){this.user=e.model}this.ev=e.events;this.user=e.model;this.indexView=new CentralAZ.Facebook.Views.FacebookConnectAccount({model:this.user,events:this.ev});_.bindAll(this);this.ev.bind("facebookLoggedIn",this.onLogin);this.ev.bind("userDeclined",this.onDecline);return this.ev.bind("connectAccountSuccessful",this.onConnected)};d.prototype.index=function(){return this.indexView.render()};d.prototype.onLogin=function(e){this.user=new CentralAZ.Facebook.Models.FacebookUser(e);return this.ev.trigger("connectAccounts")};d.prototype.onConnected=function(){console.log(this.user);this.connectedView=new CentralAZ.Facebook.Views.Connected({model:this.user,events:this.ev});this.indexView.close();return this.connectedView.render()};d.prototype.onDecline=function(){return this.indexView.close()};return d})(Backbone.Router);CentralAZ.Facebook.Controllers.FacebookLoginRouter=(function(d){b(c,d);function c(){c.__super__.constructor.apply(this,arguments)}c.prototype.routes={"":"index","!/log-in/:status":"index","!/sign-up":"signUp","*other":"index"};c.prototype.initialize=function(e){this.user=e.model;this.ev=e.events;this.indexView=new CentralAZ.Facebook.Views.FacebookLogin({events:this.ev});_.bindAll(this);this.ev.bind("facebookLoggedIn",this.onLogin);this.ev.bind("facebookLogOut",this.onLogOut);this.ev.bind("userDeclined",this.onDecline);return this.ev.bind("arenaLoginFailed",this.onArenaLoginFail)};c.prototype.index=function(e){if(e==null){e=""}if(e==="declined"){alert("boo!")}return this.indexView.render()};c.prototype.signUp=function(){if(this.user===null){this.navigate("!/log-in",true);return}this.signUpView=new CentralAZ.Facebook.Views.FacebookSignUp({model:this.user,events:this.ev});return this.signUpView.render()};c.prototype.onLogin=function(e){var f;f=CentralAZ.Web.Helpers.UrlHelper.parseQueryString();if(f.error_reason!=null){this.user=new CentralAZ.Facebook.Models.FacebookUser({name:"anonymous person"});this.navigate("!/sign-up",true);return}if(!e){return this.navigate("!/log-in",true)}this.user=new CentralAZ.Facebook.Models.FacebookUser(e);this.userInfoView=new CentralAZ.Facebook.Views.FacebookWelcome({model:this.user,events:this.ev});this.userInfoView.render();return this.ev.trigger("arenaLogin")};c.prototype.onLogOut=function(){return this.navigate("!/log-in",true)};c.prototype.onDecline=function(){return this.navigate("!/log-in/declined",true)};c.prototype.onArenaLoginFail=function(){return this.navigate("!/sign-up",true)};return c})(Backbone.Router);CentralAZ.Facebook.Helpers.Authentication=(function(){function c(){}c.initConnect=function(e){var f;f=new CentralAZ.Facebook.Models.FacebookUser(e);window.facebookConnect=new CentralAZ.Facebook.Controllers.FacebookConnectRouter({model:f,events:facebookEvents});try{Backbone.history.start()}catch(d){}return c.registerFacebookApi()};c.initLogin=function(){window.facebookAuth=new CentralAZ.Facebook.Controllers.FacebookLoginRouter({model:null,events:facebookEvents});try{Backbone.history.start()}catch(d){}return c.registerFacebookApi()};c.registerFacebookApi=function(){var d;window.fbAsyncInit=function(){return FB.init({appId:c.config.appID,status:true,cookie:true,xfbml:true,oauth:true})};d=document.createElement("script");d.src=""+document.location.protocol+"//connect.facebook.net/en_US/all.js";d.async=true;return document.getElementById("fb-root").appendChild(d)};return c})();window.facebookEvents=_.extend(CentralAZ.Facebook.Events,Backbone.Events);facebookEvents.defaults={onLoginSuccess:function(c){if(c.d>-1){return window.location=CentralAZ.Facebook.Helpers.Authentication.config.redirectPath}else{return facebookEvents.trigger("arenaLoginFailed")}},onConnectSuccess:function(c){return facebookEvents.trigger("connectAccountSuccessful")},onOptOutSuccess:function(c){return facebookEvents.trigger("optOutSuccessful")},onError:function(c,d,e){console.log(JSON.stringify(c));console.log(d);return console.log(e)}};facebookEvents.bind("arenaLogin",function(f,d){var c,e;if(f==null){f=facebookEvents.defaults.onLoginSuccess}if(d==null){d=facebookEvents.defaults.onError}c=CentralAZ.Facebook.Helpers.Authentication.config.accessToken;e=CentralAZ.Facebook.Helpers.Authentication.config.state;return $.ajax({url:"webservices/custom/cccev/core/AuthenticationService.asmx/AuthenticateFacebook",type:"POST",data:"{'accessToken': '"+c+"', 'state': '"+e+"'}",contentType:"application/json",dataType:"json",success:f,error:d})});facebookEvents.bind("facebookLogin",function(){return FB.getLoginStatus(function(c){if(c.status==="connected"){return facebookEvents.trigger("facebookLoggingIn",c)}else{return FB.login(function(d){if(d.authResponse){return facebookEvents.trigger("facebookLoggingIn",d)}else{return facebookEvents.trigger("userDeclined")}},{scope:"email,user_birthday"})}})});facebookEvents.bind("facebookLoggingIn",function(c){CentralAZ.Facebook.Helpers.Authentication.config.accessToken=c.authResponse.accessToken;return FB.api("/me",function(d){return facebookEvents.trigger("facebookLoggedIn",d)})});facebookEvents.bind("facebookLogOut",function(){if(FB){return FB.logout()}});facebookEvents.bind("connectAccounts",function(f,d){var c,e;if(f==null){f=facebookEvents.defaults.onConnectSuccess}if(d==null){d=facebookEvents.defaults.onError}c=CentralAZ.Facebook.Helpers.Authentication.config.accessToken;e=CentralAZ.Facebook.Helpers.Authentication.config.state;return $.ajax({url:"webservices/custom/cccev/core/AuthenticationService.asmx/ConnectAccountToFacebook",type:"POST",data:"{'accessToken': '"+c+"', 'state': '"+e+"'}",contentType:"application/json",dataType:"json",success:f,error:d})});facebookEvents.bind("optOut",function(e,c){var d;if(e==null){e=facebookEvents.defaults.onOptOutSuccess}if(c==null){c=facebookEvents.defaults.onError}d=CentralAZ.Facebook.Helpers.Authentication.config.state;return $.ajax({url:"webservices/custom/cccev/core/AuthenticationService.asmx/OptOutOfFacebookConnection",type:"POST",data:"{'state': '"+d+"'}",contentType:"application/json",dataType:"json",success:e,error:c})});CentralAZ.Facebook.Models.FacebookUser=(function(d){b(c,d);function c(){c.__super__.constructor.apply(this,arguments)}return c})(Backbone.Model);CentralAZ.Facebook.Models.FacebookUsers=(function(d){b(c,d);function c(){this.model=CentralAZ.Facebook.Models.FacebookUser}return c})(Backbone.Collection);CentralAZ.Facebook.Views.Connected=(function(d){b(c,d);function c(){this.className="connect-success";this.tagName="div";this.template='<img src=\'https://graph.facebook.com/{{id}}/picture?type=square\' class="imageSmall" height="50" width="50" alt={{name}} />\n<p><strong>Sweet!</strong> {{name}}, you\'re all set!</p>';c.__super__.constructor.apply(this,arguments)}c.prototype.initialize=function(e){this.ev=e.events;return this.model=e.model};c.prototype.render=function(){var e,f,g,h=this;e=this.$el;e.prependTo("body");f=this.model.toJSON();g=Mustache.to_html(this.template,f);e.html(g);return e.fadeIn("fast",function(){return setTimeout(function(){return e.fadeOut("fast",function(){return h.remove()})},5000)})};return c})(Backbone.View);CentralAZ.Facebook.Views.FacebookConnectAccount=(function(d){b(c,d);function c(){this.className="connect-account";this.tagName="div";this.template='<div class="close"><a href="#" class="fb-close">X</a></div>\n<p><strong>Hey {{name}}!</strong> We thought you might be interested in connecting your Central account to Facebook. \nThis will allow you to log into your Central account with a single click.</p>\n<p><a href="#" class="facebook-connect fbbutton" title="Connect to Facebook">Connect</a>\n<a href="#" class="fb-opt-out" title="Please don\'t ask me again">Please don\'t ask me again</a></p>';c.__super__.constructor.apply(this,arguments)}c.prototype.initialize=function(e){this.ev=e.events;this.model=e.model;_.bindAll(this);return this.ev.bind("optOutSuccessful",this.onOptedOut)};c.prototype.render=function(){var e,f,g=this;e=this.$el;e.prependTo("body");f=Mustache.to_html(this.template,this.model.toJSON());e.html(f);this.inTimer=setTimeout(function(){return e.fadeIn("slow")},5000);return this.outTimer=setTimeout(function(){return g.close()},15000)};c.prototype.events={"click .facebook-connect":"connectAccount","click .fb-close":"close","click .fb-opt-out":"optOut"};c.prototype.connectAccount=function(){this.ev.trigger("facebookLogin");return false};c.prototype.close=function(){var e=this;$(this.el).fadeOut("slow",function(){return $(e.el).remove()});clearTimeout(this.outTimer);return false};c.prototype.optOut=function(){this.ev.trigger("optOut");return false};c.prototype.onOptedOut=function(){return this.close()};return c})(Backbone.View);CentralAZ.Facebook.Views.FacebookLogin=(function(d){b(c,d);function c(){this.setElement("#log-in");this.unbind();c.__super__.constructor.apply(this,arguments)}c.prototype.initialize=function(e){return this.ev=e.events};c.prototype.render=function(){var e;e=$(this.el);return $(".fb-auth > div").fadeOut("slow",function(){e.fadeIn("slow");return false})};c.prototype.events={"click .facebook-login":"logIn"};c.prototype.logIn=function(){this.ev.trigger("facebookLogin");return false};c.prototype.unbind=function(){return this.$el.undelegate(".facebook-login","click")};return c})(Backbone.View);CentralAZ.Facebook.Views.FacebookSignUp=(function(c){b(d,c);function d(){this.setElement("#signup-form");this.template='<h3>Hi {{name}}</h3>\n<img src=\'https://graph.facebook.com/{{id}}/picture?type=square\' class="imageSmall" height="50" width="50" alt={{name}} />\n<p><strong>Almost done!</strong> Just need to link your Central account to Facebook. Which of these options sounds right?</p>';this.unbind();d.__super__.constructor.apply(this,arguments)}d.prototype.initialize=function(e){this.ev=e.events;return _.bindAll(this,"logOut")};d.prototype.render=function(){var e,f;$(".greeting").empty();f=Mustache.to_html(this.template,this.model.toJSON());$(".greeting").html(f);$("input[id$='tbFirstName']").val(this.model.get("first_name"));$("input[id$='tbLastName']").val(this.model.get("last_name"));$("input[id$='tbEmail']").val(this.model.get("email"));$("input[id$='tbBirthdate']").val(this.model.get("birthday"));$("input[id$='ihAccessToken']").val(CentralAZ.Facebook.Helpers.Authentication.config.accessToken);$(".im-new, .have-account").next("div").hide();e=this;return this.$el.siblings().fadeOut("slow",function(){e.$el.fadeIn("slow");return false})};d.prototype.events={"click .fblogout":"logOut","click .im-new":"register","click .have-account":"signIn"};d.prototype.logOut=function(){this.ev.trigger("facebookLogOut");return false};d.prototype.register=function(){$(".have-account").next("div").slideUp();$(".im-new").next("div").slideToggle();return false};d.prototype.signIn=function(){$(".im-new").next("div").slideUp();$(".have-account").next("div").slideToggle();return false};d.prototype.unbind=function(){this.$el.undelegate(".fb-logout","click");this.$el.undelegate(".im-new","click");return this.$el.undelegate(".have-account","click")};return d})(Backbone.View);CentralAZ.Facebook.Views.FacebookWelcome=(function(d){b(c,d);function c(){this.setElement("#user-info");this.template='<img src=\'https://graph.facebook.com/{{id}}/picture?type=square\' class="imageSmall" height="50" width="50" alt={{name}} />\n<p>Welcome {{name}}! Hang tight, we\'re logging you in.</p>';c.__super__.constructor.apply(this,arguments)}c.prototype.initialize=function(e){return this.ev=e.events};c.prototype.render=function(){var f,e;f=this.$el;e=Mustache.to_html(this.template,this.model.toJSON());return f.siblings().fadeOut("slow",function(){f.html(e);f.fadeIn("slow");return false})};return c})(Backbone.View)}).call(this);
